# HW6 - k3s è½‰æ›ç¸½è¦½

æœ¬æ–‡ä»¶ç¸½çµäº†å°‡ HW6 å¾ Docker Swarm è½‰æ›ç‚º k3s çš„æ‰€æœ‰è®Šæ›´ã€‚

## ğŸ“‹ æ–°å¢æª”æ¡ˆæ¸…å–®

### Kubernetes Manifests (content/k3s/)
- âœ… `namespace.yaml` - å®šç¾© mcapp å‘½åç©ºé–“
- âœ… `database.yaml` - PostgreSQL StatefulSetã€PVCã€ConfigMapã€Secret
- âœ… `backend.yaml` - å¾Œç«¯ API Deployment å’Œ Service
- âœ… `frontend.yaml` - å‰ç«¯ Web Deployment å’Œ Service (NodePort)
- âœ… `ingress.yaml` - Traefik Ingress é…ç½®
- âœ… `kustomization.yaml` - Kustomize é…ç½®æª”æ¡ˆ
- âœ… `README.md` - k3s éƒ¨ç½²è©³ç´°èªªæ˜

### æ“ä½œè…³æœ¬ (ops/)
- âœ… `init-k3s.sh` - å®‰è£ä¸¦åˆå§‹åŒ– k3s
- âœ… `deploy-k3s.sh` - éƒ¨ç½²æ‡‰ç”¨åˆ° k3s
- âœ… `verify-k3s.sh` - é©—è­‰ k3s éƒ¨ç½²ç‹€æ…‹
- âœ… `cleanup-k3s.sh` - æ¸…ç†æ‡‰ç”¨/å¸è¼‰ k3s
- âœ… `build-images.sh` - å»ºç½®å’Œæ¨é€ Docker æ˜ åƒæª”

### æ–‡ä»¶ (docs/ å’Œæ ¹ç›®éŒ„)
- âœ… `README.md` - ä¸»è¦èªªæ˜æ–‡ä»¶ï¼ˆæ›´æ–°ï¼‰
- âœ… `QUICKREF.md` - å¿«é€Ÿåƒè€ƒæŒ‡å—
- âœ… `docs/MIGRATION.md` - Swarm åˆ° k3s é·ç§»æŒ‡å—
- âœ… `docs/EVIDENCE.md` - éƒ¨ç½²è­‰æ˜æ–‡ä»¶ï¼ˆæ›´æ–°ï¼‰

## ğŸ”„ ä¿ç•™æª”æ¡ˆï¼ˆåƒè€ƒç”¨ï¼‰

ä»¥ä¸‹ Docker Swarm ç›¸é—œæª”æ¡ˆä¿ç•™ä½œç‚ºåƒè€ƒï¼š
- `content/swarm/stack.yaml` - åŸ Swarm éƒ¨ç½²é…ç½®
- `content/swarm/README.md` - Swarm ä½¿ç”¨èªªæ˜
- `ops/init-swarm.sh` - Swarm åˆå§‹åŒ–è…³æœ¬
- `ops/deploy.sh` - Swarm éƒ¨ç½²è…³æœ¬
- `ops/verify.sh` - Swarm é©—è­‰è…³æœ¬
- `ops/cleanup.sh` - Swarm æ¸…ç†è…³æœ¬

## ğŸ“Š æ¶æ§‹å°æ¯”

### ä¹‹å‰ (Docker Swarm)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Manager Node (Student Laptop)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   web    â”‚  â”‚   api    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚             â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚               â”‚                    â”‚
â”‚         Overlay Network            â”‚
â”‚               â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Node (Lab Machine)        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”               â”‚
â”‚         â”‚    db    â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚              â”‚                     â”‚
â”‚      Volume: dbdata                â”‚
â”‚  /var/lib/postgres-data            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¹‹å¾Œ (k3s/Kubernetes)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  k3s Node                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Namespace: mcapp                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Deployment: web (1 rep)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Service: NodePort (30080) â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Deployment: api (2 reps)  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Service: ClusterIP        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  StatefulSet: db (1 rep)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Service: ClusterIP        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  PVC: postgres-pvc (5Gi)   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Network: Flannel CNI                  â”‚
â”‚  Ingress: Traefik                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ä¸»è¦æ”¹é€²

### 1. é«˜å¯ç”¨æ€§
- âœ… å¾Œç«¯ API å¾ 1 å€‹å‰¯æœ¬å¢åŠ åˆ° 2 å€‹å‰¯æœ¬
- âœ… è‡ªå‹•æ•…éšœè½‰ç§»å’Œé‡å•Ÿ
- âœ… å¥åº·æª¢æŸ¥ (liveness å’Œ readiness probes)

### 2. å„²å­˜ç®¡ç†
- âœ… ä½¿ç”¨ PersistentVolumeClaim å–ä»£ Docker volume
- âœ… æ›´å¥½çš„å„²å­˜æŠ½è±¡
- âœ… æ”¯æ´å¤šç¨®å„²å­˜å¾Œç«¯

### 3. ç¶²è·¯
- âœ… ä½¿ç”¨ Kubernetes Service é€²è¡Œæœå‹™ç™¼ç¾
- âœ… Traefik Ingress Controller è™•ç†å¤–éƒ¨æµé‡
- âœ… NetworkPolicy æ”¯æ´ï¼ˆå¯é¸ï¼‰

### 4. é…ç½®ç®¡ç†
- âœ… ä½¿ç”¨ ConfigMap ç®¡ç†é…ç½®
- âœ… ä½¿ç”¨ Secret ç®¡ç†æ•æ„Ÿè³‡è¨Š
- âœ… ç’°å¢ƒè®Šæ•¸æ³¨å…¥

### 5. éƒ¨ç½²ç®¡ç†
- âœ… æ»¾å‹•æ›´æ–° (Rolling Update)
- âœ… å›æ»¾æ”¯æ´
- âœ… æ›´ç²¾ç´°çš„éƒ¨ç½²æ§åˆ¶

### 6. ç›£æ§èˆ‡é™¤éŒ¯
- âœ… è±å¯Œçš„ kubectl æŒ‡ä»¤
- âœ… è©³ç´°çš„è³‡æºç‹€æ…‹å’Œäº‹ä»¶
- âœ… æ›´å¥½çš„æ—¥èªŒç®¡ç†

## ğŸ“ ä½¿ç”¨æµç¨‹

### å¿«é€Ÿé–‹å§‹
```bash
# 1. åˆå§‹åŒ– k3s
cd HW6/ops
sudo bash init-k3s.sh

# 2. éƒ¨ç½²æ‡‰ç”¨
sudo bash deploy-k3s.sh

# 3. é©—è­‰éƒ¨ç½²
sudo bash verify-k3s.sh

# 4. å­˜å–æ‡‰ç”¨
# ç€è¦½å™¨é–‹å•Ÿ: http://localhost:30080
```

### æ—¥å¸¸æ“ä½œ
```bash
# æŸ¥çœ‹ç‹€æ…‹
sudo k3s kubectl get all -n mcapp

# æŸ¥çœ‹æ—¥èªŒ
sudo k3s kubectl logs -n mcapp -l app=api -f

# æ“´å±•æ‡‰ç”¨
sudo k3s kubectl scale deployment api -n mcapp --replicas=3

# æ›´æ–°æ˜ åƒæª”
sudo bash ops/deploy-k3s.sh --build
```

### æ¸…ç†
```bash
# åƒ…ç§»é™¤æ‡‰ç”¨
sudo bash ops/cleanup-k3s.sh

# å®Œå…¨å¸è¼‰
sudo bash ops/cleanup-k3s.sh --uninstall-k3s
```

## ğŸ” é—œéµç‰¹æ€§

### 1. å‘½åç©ºé–“éš”é›¢
æ‰€æœ‰è³‡æºéƒ½éƒ¨ç½²åœ¨ `mcapp` å‘½åç©ºé–“ä¸­ï¼Œæä¾›è³‡æºéš”é›¢ã€‚

### 2. StatefulSet for Database
ä½¿ç”¨ StatefulSet éƒ¨ç½²è³‡æ–™åº«ï¼Œç¢ºä¿ï¼š
- ç©©å®šçš„ç¶²è·¯è­˜åˆ¥
- æœ‰åºçš„éƒ¨ç½²å’Œæ“´å±•
- æŒä¹…åŒ–å„²å­˜

### 3. ConfigMap for Init SQL
ä½¿ç”¨ ConfigMap å„²å­˜è³‡æ–™åº«åˆå§‹åŒ–è…³æœ¬ï¼Œä¾¿æ–¼ç®¡ç†å’Œæ›´æ–°ã€‚

### 4. Secret for Credentials
ä½¿ç”¨ Kubernetes Secret å„²å­˜è³‡æ–™åº«æ†‘è­‰ï¼Œæé«˜å®‰å…¨æ€§ã€‚

### 5. Health Checks
æ‰€æœ‰æœå‹™éƒ½é…ç½®äº†å¥åº·æª¢æŸ¥ï¼š
- Liveness Probe: æª¢æ¸¬å®¹å™¨æ˜¯å¦å­˜æ´»
- Readiness Probe: æª¢æ¸¬å®¹å™¨æ˜¯å¦å°±ç·’æ¥æ”¶æµé‡

### 6. NodePort Service
å‰ç«¯ä½¿ç”¨ NodePort é¡å‹çš„ Serviceï¼Œå¯é€é `http://localhost:30080` å­˜å–ã€‚

### 7. Ingress Support
é…ç½® Traefik Ingressï¼Œæ”¯æ´åŸºæ–¼ä¸»æ©Ÿåæˆ–è·¯å¾‘çš„è·¯ç”±ã€‚

## ğŸ“š æ–‡ä»¶çµæ§‹

```
HW6/
â”œâ”€â”€ README.md                    # ä¸»è¦èªªæ˜
â”œâ”€â”€ QUICKREF.md                  # å¿«é€Ÿåƒè€ƒ
â”œâ”€â”€ content/
â”‚   â”œâ”€â”€ k3s/                     # Kubernetes manifests
â”‚   â”‚   â”œâ”€â”€ README.md            # k3s éƒ¨ç½²èªªæ˜
â”‚   â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”‚   â”œâ”€â”€ database.yaml
â”‚   â”‚   â”œâ”€â”€ backend.yaml
â”‚   â”‚   â”œâ”€â”€ frontend.yaml
â”‚   â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”‚   â””â”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ swarm/                   # Swarm é…ç½®ï¼ˆåƒè€ƒï¼‰
â”‚   â”œâ”€â”€ backend/                 # å¾Œç«¯æºç¢¼
â”‚   â”œâ”€â”€ frontend/                # å‰ç«¯æºç¢¼
â”‚   â””â”€â”€ db/                      # è³‡æ–™åº«è…³æœ¬
â”œâ”€â”€ ops/                         # æ“ä½œè…³æœ¬
â”‚   â”œâ”€â”€ init-k3s.sh             # k3s åˆå§‹åŒ–
â”‚   â”œâ”€â”€ deploy-k3s.sh           # k3s éƒ¨ç½²
â”‚   â”œâ”€â”€ verify-k3s.sh           # k3s é©—è­‰
â”‚   â”œâ”€â”€ cleanup-k3s.sh          # k3s æ¸…ç†
â”‚   â”œâ”€â”€ build-images.sh         # æ˜ åƒæª”å»ºç½®
â”‚   â”œâ”€â”€ init-swarm.sh           # Swarm åˆå§‹åŒ–ï¼ˆåƒè€ƒï¼‰
â”‚   â”œâ”€â”€ deploy.sh               # Swarm éƒ¨ç½²ï¼ˆåƒè€ƒï¼‰
â”‚   â”œâ”€â”€ verify.sh               # Swarm é©—è­‰ï¼ˆåƒè€ƒï¼‰
â”‚   â””â”€â”€ cleanup.sh              # Swarm æ¸…ç†ï¼ˆåƒè€ƒï¼‰
â””â”€â”€ docs/
    â”œâ”€â”€ MIGRATION.md            # é·ç§»æŒ‡å—
    â””â”€â”€ EVIDENCE.md             # éƒ¨ç½²è­‰æ˜
```

## ğŸ“ å­¸ç¿’è³‡æº

### k3s ç›¸é—œ
- [k3s å®˜æ–¹æ–‡ä»¶](https://docs.k3s.io/)
- [k3s GitHub](https://github.com/k3s-io/k3s)

### Kubernetes ç›¸é—œ
- [Kubernetes å®˜æ–¹æ–‡ä»¶](https://kubernetes.io/docs/)
- [Kubernetes æ¦‚å¿µ](https://kubernetes.io/docs/concepts/)
- [kubectl å‚™å¿˜å–®](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)

### Traefik ç›¸é—œ
- [Traefik æ–‡ä»¶](https://doc.traefik.io/traefik/)
- [Traefik Kubernetes Ingress](https://doc.traefik.io/traefik/providers/kubernetes-ingress/)

## âœ… æª¢æŸ¥æ¸…å–®

éƒ¨ç½²å‰ç¢ºèªï¼š
- [ ] Linux ç³»çµ±ï¼ˆUbuntu, Debian, CentOS ç­‰ï¼‰
- [ ] Docker å·²å®‰è£
- [ ] sudo æ¬Šé™
- [ ] è¶³å¤ çš„ç£ç¢Ÿç©ºé–“ï¼ˆå»ºè­° 10GB+ï¼‰
- [ ] ç¶²è·¯é€£ç·šï¼ˆä¸‹è¼‰ k3s å’Œæ˜ åƒæª”ï¼‰

éƒ¨ç½²å¾Œé©—è­‰ï¼š
- [ ] k3s ç¯€é»ç‹€æ…‹ç‚º Ready
- [ ] æ‰€æœ‰ Pods ç‹€æ…‹ç‚º Running
- [ ] Services æœ‰æ­£ç¢ºçš„ Endpoints
- [ ] å¯é€é NodePort å­˜å–æ‡‰ç”¨
- [ ] è³‡æ–™åº«é€£æ¥æ­£å¸¸
- [ ] API å¥åº·æª¢æŸ¥é€šé
- [ ] å‰ç«¯é é¢æ­£å¸¸é¡¯ç¤º

## ğŸš€ ä¸‹ä¸€æ­¥

å¯ä»¥è€ƒæ…®çš„æ”¹é€²ï¼š
1. æ·»åŠ  HorizontalPodAutoscaler å¯¦ç¾è‡ªå‹•æ“´å±•
2. é…ç½® NetworkPolicy å¯¦ç¾ç¶²è·¯éš”é›¢
3. æ·»åŠ  Prometheus å’Œ Grafana é€²è¡Œç›£æ§
4. ä½¿ç”¨ Helm Chart ç°¡åŒ–éƒ¨ç½²
5. é…ç½® RBAC æé«˜å®‰å…¨æ€§
6. æ·»åŠ  CI/CD æµç¨‹
7. ä½¿ç”¨ Cert-Manager ç®¡ç† SSL æ†‘è­‰
8. é…ç½®å¤šç¯€é»å¢é›†

## ğŸ“ æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹åƒè€ƒï¼š
1. `README.md` - ä¸»è¦èªªæ˜
2. `QUICKREF.md` - å¿«é€Ÿåƒè€ƒ
3. `content/k3s/README.md` - k3s è©³ç´°èªªæ˜
4. `docs/MIGRATION.md` - é·ç§»æŒ‡å—

æˆ–æŸ¥çœ‹ç›¸é—œæ—¥èªŒï¼š
```bash
# æŸ¥çœ‹ Pod æ—¥èªŒ
sudo k3s kubectl logs -n mcapp <pod-name>

# æŸ¥çœ‹ Pod äº‹ä»¶
sudo k3s kubectl describe pod -n mcapp <pod-name>

# æŸ¥çœ‹æ‰€æœ‰äº‹ä»¶
sudo k3s kubectl get events -n mcapp --sort-by='.lastTimestamp'
```

---

**å®Œæˆæ—¥æœŸ**: 2025å¹´11æœˆ6æ—¥  
**ç‰ˆæœ¬**: HW6 k3s Migration v1.0  
**ç‹€æ…‹**: âœ… å®Œæˆ
